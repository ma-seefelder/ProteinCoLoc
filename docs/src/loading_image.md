```@meta
CurrentModule = ProteinCoLoc
```

# Loading images
```@contents
Pages = ["loading_image.md"]
```

## Data types and Interface
All images need to be represented as the mutable struct `MultiChannelImage` for further use with ProteinCoLoc.jl. This `MultiChannelImage` allows storing all pixel itensities, channel names, the image name, path to the individual channel images, the size of the image as well as the Otsu's threshold for each color channel. 

```@docs
MultiChannelImage
```

A `MultiChannelImage` can be created either manually or by calling the external constructor that loads tiff files into a `MultiChannelImage` 

```@docs
MultiChannelImage(name::S, path::Vector{S}, channels::Vector{S} =[]) where {S <: AbstractString}
```

Several instances of type `MultiChannelImage` can be stored as a `MultiChannelImageStack{T <:MultiChannelImage, S <: AbstractString}`. For example images taken from the samples of the same biological condition can be grouped in an `MultiChannelImageStack`for further downstream analysis. A `MultiChannelImageStack`can be generated by using the constructor `MultiChannelImageStack(img, name)`  

```@docs
MultiChannelImageStack
```

The following methods are defined for an object of type `MultiChannelImageStack`:

- `getindex(stack, i)`: Method to retrieve the `MultiChannelImage` at index i of the `MultiChannelImageStack` stack.
- `Ã¬terate(stack, state)`: Method to iterate over the images in the `MultiChannelImageStack` stack. This method definition allows the use of for-loops etc with MultiChannelImageStacks. 

```@docs
Base.getindex(stack::MultiChannelImageStack, i::Int64)
Base.iterate(stack::MultiChannelImageStack, state)
```

## Load tiff-file

Images can be loaded from a file using the function 'load_tiff'. This function converts the RGB image into a greyscale image and returns a `Matrix{Float64}`

```@docs
load_tiff(path::S) where {S<:AbstractString}
```

## Computing and applying image mask

The image mask using Otsu thresholding can be computed and directly applied to an img of type `MultiChannelImage` using the function `apply_mask!(img)`.

```@docs
apply_mask!
```

!!! warning "_calculate_mask and _apply_mask! are not part of the public API"
    In addition, two low-level function are available to perform these steps individually. These functions are not part of the public API and might change in the future. 

```@docs
_calculate_mask
_apply_mask!(img, mask)
```

## Generation of control images

ProteinCoLocs provides two different ways to generate artificial control images. As discussed in our [paper](https://doi.org/10.1038/s41598-024-63884-1), the use of randomly shuffled or block shuffled image are not ideal as these may lead to unreliable results. Therefore, we strongly recommend the use of dedicated control images (e.g. control staining without primary antibodies) that have been taken with the same settings.

The first image randomly shuffles all pixels of each color channel. 

```@docs
shuffle_pixels
```

The second method shuffles blocks of pixels in each channel of a `MultiChannelImage`. The block shuffling should retain the autocorrelation between neighboring pixels.

```@docs
shuffle_blocks
```